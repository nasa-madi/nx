---
sidebar_position: 35
title: Direct API Access
slug: /api/direct-access
---

# Direct API Access through IAP

:::warning
This page is incomplete and may not contain fully accurate information. Please refer to the official Google Cloud documentation or contact your system administrator for confirmation.
:::

In a production environment, accessing the API hosted behind the Identity-Aware Proxy (IAP) within Google Cloud Platform (GCP) may require additional authentication steps. This guide walks you through accessing the API when it is protected by IAP and not otherwise accessible, as is the default configuration provided by Terraform for the MADI stack.



### Prerequisites

Before you begin, ensure you have the following:

- Google Cloud SDK (`gcloud`) installed on your local machine.
- Proper authentication credentials and permissions to access the GCP project and the API service.
- The API you wish to access must be deployed and running in Cloud Run.

### Step 1: Authenticate with Your User Credentials

First, you need to authenticate your local machine with your Google account that has the necessary permissions to access the GCP project.

```shell
gcloud auth login
```

This command opens a browser window where you can log in with your Google account. Once authenticated, your local machine is authorized to interact with Google Cloud services under your account.

### Step 2: Set Up a Local Proxy for Cloud Run

After authentication, you'll need to create a local proxy that connects to the API service running on Cloud Run. This proxy allows you to interact with the API as if it were running on your local machine.


#### Define Environment Variables

Start by setting the necessary environment variables:

```shell
PROJECT_ID=<your-project-id>
SERVICE_NAME=<your-api-service-name>
REGION=<your-api-service-region>
```

Retrieve these values using:

```shell
gcloud run services list
```

Replace `<your-project-id>` and `<your-service-name>` with your actual GCP project ID and the name of the Cloud Run service hosting the API. For example:

```shell
PROJECT_ID=madi-dev-123abcd
SERVICE_NAME=api-madi-dev-123abcd
REGION=us-east4
```

#### Create the Proxy

Now, run the following command to create the local proxy:

```shell
gcloud beta run services proxy $SERVICE_NAME --port=8080 --project=$PROJECT_ID --region=$REGION
```

The proxy will now be running on `http://localhost:8080`, allowing you to interact with the Cloud Run service as if it were a local service.

### Step 3: Test the API via Local Proxy

To confirm that the API is accessible through the proxy, you can send a test request using `curl`:

```shell
curl -s --request GET --header "Authorization: Bearer $(gcloud auth print-access-token)" "http://localhost:8080/tools"
```

:::info
If you are getting a 404, make sure to check that your Cloud Run service is set to "Allow direct access to your service from the internet."  This is under `Networking`->`Ingress Control`->`All`.  By default the GCP Terraform templates restrict this acccess to VPC only.
:::



#### Explanation

- **`Authorization: Bearer $(gcloud auth print-access-token)`**: This part generates a new access token for your authenticated session and includes it in the request header, allowing IAP to recognize your request as authorized.
- **`http://localhost:8080/tools`**: This is the endpoint you're testing. Replace `/tools` with any endpoint you wish to test.

If the API is working correctly, you should see a successful response from the server.

### Step 4: Using the Access Token in Other Tools

The access token generated with `gcloud auth print-access-token` can also be used in other tools like Postman or other CLI-based tools for testing and development. The user permissions applied to this token are the same as those for accessing the API via IAP, ensuring consistent behavior regardless of the access method.

#### Example in Postman

1. Open Postman.
2. Create a new request with the same URL (`http://localhost:8080/tools`).
3. Under the `Authorization` tab, select `Bearer Token` as the type.
4. Paste the access token generated by `gcloud auth print-access-token` into the `Token` field.
5. Send the request.

If everything is set up correctly, you should receive a response from the API.

### Troubleshooting

If you encounter issues while setting up the proxy or accessing the API, consider the following:

- **Permissions**: Ensure your Google account has the necessary permissions to access the GCP project and the Cloud Run service.
- **Correct Region**: Verify that you've selected the correct region when setting up the proxy.
- **Service Availability**: Confirm that the Cloud Run service is running and healthy in the GCP Console.

For further assistance, refer to the official Google Cloud documentation on [Identity-Aware Proxy](https://cloud.google.com/iap/docs/) and [Cloud Run](https://cloud.google.com/run/docs/), or consult with your system administrator.